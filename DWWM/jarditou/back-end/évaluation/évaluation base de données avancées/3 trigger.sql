/*
+-------------------+
|  premier trigger  |
+-------------------+
Ce trigger devra mettre a jour dans la table orders la ligne ord_status et mettre 'Commande livrée' si une date de reception est entrer.
*/
-------------------------------------
DELIMITER $$

DROP TRIGGER IF EXISTS reception_update $$
CREATE TRIGGER reception_update

BEFORE UPDATE ON `orders`
FOR EACH ROW

BEGIN

DECLARE verify DATE;
DECLARE commande_p varchar(40);
DECLARE bidon INT(1);
SET verify = new.ord_reception_date;
SET commande_p = old.ord_status;
SET bidon = 0;

IF (NEW.ord_reception_date = OLD.ord_reception_date)
THEN
    SET bidon = 1;
END IF;

IF (verify IS NOT NULL || bidon = 0)
THEN 
    IF (commande_p = 'Commande urgente')
    THEN
    SET new.ord_status = 'Commande urgente livrée';
    ELSE
    SET new.ord_status = 'Commande livrée';
    END IF;
END IF ;
END $$

DELIMITER ;
-------------------------------------



/*
+---------------------+
|  deuxièmem trigger  |
+---------------------+
ce trigger est identique ou presque au premier trigger
*/
-------------------------------------
DELIMITER $$

DROP TRIGGER IF EXISTS livraison_fait $$
CREATE TRIGGER livraison_fait
BEFORE INSERT INTO ON orders
FOR EACH ROW
BEGIN
    DECLARE date_old date;
    DECLARE date_new date;
    DECLARE status   varchar(25);
    SET date_old = OLD.ord_reception_date;
    SET date_new = NEW.ord_reception_date;
    IF (date_new IS NOT NULL || date_old IS NULL)
    THEN
        SET status = OLD.ord_status;
        IF (status LIKE '%urgente%')
        THEN
            SET NEW.ord_status = 'Commande urgente livrée';
        ELSE
            SET NEW.ord_status = 'Commande livrée';
        END IF;
    END IF;
END $$

DELIMITER ;
-------------------------------------



/*
+---------------------+
|  troisième trigger  |
+---------------------+

*/
-------------------------------------
DELIMITER $$

DROP TRIGGER IF EXISTS compteur_client $$
CREATE TRIGGER compteur_client
AFTER INSERT ON `orders`
FOR EACH ROW
BEGIN
    DECLARE nb_commande int(4);

    SET nb_commande = (SELECT count(ord_id) FROM orders WHERE ord_cus_id = NEW.ord_cus_id);
    UPDATE `customers`
    SET cus_nb_orders = (nb_commande) WHERE cus_id = NEW.ord_cus_id;

    END $$
DELIMITER ;


-------------------------------------
ALTER TABLE `customers` 
ADD `cus_nb_orders` INT(4) NULL DEFAULT NULL AFTER `cus_update_date`;

ALTER TABLE `customers` ADD `cus_tot_orders` float NULL DEFAULT NULL AFTER `cus_nb_orders`; 

-------------------------------------

INSERT INTO `orders` (`ord_id`, `ord_order_date`, `ord_payment_date`, `ord_ship_date`, `ord_reception_date`, `ord_status`, `ord_cus_id`) VALUES
(1, '2008-08-20', '2018-12-01', '2019-08-29', NULL, 'Commande livrée', 17),
(2, '2016-01-22', '2011-02-02', '2013-04-13', '2004-10-29', NULL, 67),
(3, '2019-12-25', '2000-03-28', '2009-08-04', '2021-03-24', NULL, 85),
(4, '2016-08-18', '2004-02-06', '2014-12-29', '2008-07-26', 'Commande urgente', 88),
(5, '2009-06-19', '2012-10-07', '2017-08-30', '2010-09-20', NULL, 27),
(6, '2012-08-18', '2006-09-05', '2018-02-08', '2001-05-04', NULL, 95),
(7, '2010-09-01', '2016-02-02', '2006-11-24', '2016-10-19', NULL, 78),
(8, '2021-04-01', '2016-02-05', '2004-08-13', '2016-01-07', NULL, 34),
(9, '2012-08-14', '2013-01-28', '2009-07-29', '2003-07-31', NULL, 51),
(10, '2014-06-19', '2005-09-12', '2016-09-04', '2002-05-21', 'Commande urgente', 28),
(11, '2015-09-21', '2012-09-08', '2003-04-21', '2019-05-31', NULL, 59),
(12, '2008-05-02', '2001-01-10', '2006-02-26', '2002-10-22', NULL, 36),
(13, '2005-08-19', '2014-06-17', '2020-06-14', '2000-07-13', NULL, 96),
(14, '2016-05-16', '2020-12-10', '2009-06-23', '2006-10-04', NULL, 79),
(15, '2007-06-03', '2014-11-21', '2012-07-09', '2001-07-09', NULL, 56),
(16, '2019-06-14', '2000-07-30', '2014-05-16', NULL, 'Commande annulée', 81),
(17, '2020-07-13', '2008-10-12', '2014-06-10', '2005-01-27', NULL, 34),
(19, '2021-01-12', '2009-05-28', '2004-07-02', '2010-11-02', NULL, 98),
(20, '2000-08-15', '2017-01-06', '2020-06-17', '2016-02-24', NULL, 1),
(21, '2020-08-18', '2005-02-15', '2007-08-11', '2013-11-04', 'Commande urgente', 36),
(22, '2016-03-24', '2002-04-15', '2002-11-10', '2005-01-27', 'Commande urgente', 67),
(23, '2002-11-13', '2011-08-24', '2000-03-24', '2013-11-03', NULL, 34),
(24, '2004-04-06', '2016-01-12', '2018-04-16', '2013-04-22', NULL, 38),
(25, '2020-05-07', '2013-03-20', '2001-08-08', NULL, 'Commande annulée', 30),
(26, '2009-03-20', '2010-02-06', '2002-02-18', '2009-10-27', NULL, 90),
(27, '2012-09-18', '2014-06-12', '2017-11-22', '2018-06-06', NULL, 9),
(28, '2006-11-03', '2005-05-28', '2012-12-09', '2020-07-29', NULL, 1),
(29, '2010-06-25', '2000-08-18', '2001-04-25', '2005-03-07', NULL, 24),
(30, '2006-10-23', '2012-07-19', '2009-07-18', '2009-08-25', NULL, 67),
(31, '2002-06-24', '2002-07-08', '2015-02-16', '2019-02-05', NULL, 12),
(32, '2016-08-13', '2017-07-25', '2016-07-27', '2011-04-26', NULL, 27),
(33, '2009-10-11', '2019-10-16', '2010-01-18', '2016-07-10', NULL, 85),
(34, '2016-01-08', '2012-07-11', '2005-10-27', '2008-08-23', NULL, 43),
(35, '2002-09-03', '2005-02-10', '2009-07-05', '2006-12-04', NULL, 52),
(36, '2014-03-28', '2005-01-25', '2010-07-29', '2012-06-15', NULL, 69),
(37, '2007-08-21', '2020-08-29', '2014-04-07', '2010-10-23', NULL, 10),
(38, '2002-04-01', '2012-11-25', '2009-06-13', '2002-10-14', NULL, 91),
(39, '2009-02-16', '2017-11-30', '2002-08-22', '2018-08-02', NULL, 64),
(40, '2016-02-21', '2014-04-07', '2015-04-29', '2020-05-19', NULL, 19),
(41, '2007-11-12', '2002-08-28', '2010-11-06', '2016-12-28', NULL, 19),
(42, '2020-04-09', '2000-09-08', '2001-06-09', '2014-09-22', NULL, 6),
(43, '2020-02-02', '2000-02-14', '2000-12-04', '2012-10-13', NULL, 57),
(45, '2015-11-01', '2010-08-15', '2015-03-28', '2017-09-05', NULL, 56),
(46, '2000-08-01', '2000-01-14', '2020-11-22', '2011-02-01', NULL, 84),
(47, '2004-01-31', '2006-07-01', '2009-02-18', '2010-04-01', NULL, 93),
(48, '2000-07-07', '2007-08-14', '2020-03-01', '2000-02-19', NULL, 43),
(49, '2013-12-23', '2007-11-04', '2003-01-01', '2013-01-20', NULL, 8),
(50, '2004-05-26', '2011-11-05', '2006-08-16', '2017-03-05', NULL, 33),
(51, '2001-09-08', '2009-04-01', '2014-11-14', '2013-07-14', NULL, 81),
(52, '2013-06-24', '2017-09-14', '2021-04-01', '2014-01-26', NULL, 44),
(53, '2012-12-05', '2014-04-21', '2016-02-18', '2006-03-26', NULL, 5),
(54, '2005-08-03', '2015-10-19', '2017-11-10', '2012-10-20', NULL, 11),
(55, '2013-05-11', '2010-09-20', '2002-06-04', '2008-01-02', NULL, 1),
(56, '2020-04-18', '2012-06-06', '2017-09-04', '2020-11-08', NULL, 94),
(57, '2001-09-30', '2009-02-13', '2012-09-16', '2010-04-14', NULL, 70),
(58, '2003-01-12', '2006-08-29', '2008-05-29', '2016-07-21', NULL, 87),
(59, '2001-11-23', '2012-10-28', '2000-05-14', '2001-03-17', NULL, 59),
(60, '2015-01-16', '2017-01-27', '2013-09-01', '2018-04-29', NULL, 35),
(61, '2006-10-06', '2019-02-01', '2002-02-18', '2005-08-23', NULL, 81),
(62, '2019-09-02', '2005-10-17', '2017-06-20', '2013-10-30', NULL, 38),
(63, '2006-06-07', '2005-08-07', '2014-11-12', '2013-07-05', NULL, 28),
(64, '2005-01-01', '2018-04-21', '2021-01-02', '2006-04-26', NULL, 77),
(65, '2006-12-31', '2016-05-07', '2007-11-24', '2002-02-10', NULL, 54),
(66, '2014-05-30', '2014-03-31', '2012-10-25', '2018-12-10', NULL, 87),
(67, '2013-12-25', '2019-03-03', '2012-11-27', '2006-08-15', NULL, 10),
(68, '2003-11-09', '2018-04-14', '2012-08-26', '2011-06-18', NULL, 95),
(69, '2019-07-26', '2003-11-10', '2019-06-03', '2006-09-05', NULL, 31),
(70, '2020-03-12', '2006-05-14', '2003-11-23', '2013-10-17', NULL, 46),
(71, '2016-10-08', '2013-01-14', '2009-10-27', '2009-12-01', NULL, 99),
(72, '2013-06-01', '2020-12-02', '2010-03-13', '2013-04-01', NULL, 39),
(73, '2011-07-06', '2002-03-29', '2005-04-28', '2003-11-23', NULL, 67),
(74, '2018-08-29', '2016-01-31', '2016-09-08', '2012-09-23', NULL, 26),
(75, '2007-07-26', '2006-07-09', '2001-06-27', '2000-04-12', NULL, 13),
(76, '2015-06-22', '2014-07-12', '2019-11-22', '2018-04-30', NULL, 43),
(77, '2002-09-20', '2008-06-26', '2011-04-15', '2005-10-25', NULL, 70),
(78, '2015-04-25', '2003-05-05', '2006-06-26', '2015-08-16', NULL, 83),
(79, '2013-01-17', '2015-07-15', '2011-04-14', '2010-04-01', NULL, 60),
(80, '2008-07-11', '2019-09-06', '2013-07-17', '2020-05-26', NULL, 83),
(81, '2013-11-28', '2001-04-11', '2019-10-20', '2006-01-25', NULL, 72),
(82, '2001-07-23', '2002-09-02', '2008-06-10', '2009-11-04', NULL, 39),
(83, '2000-02-19', '2015-05-15', '2013-07-23', '2004-08-12', NULL, 14),
(84, '2016-07-05', '2021-01-13', '2010-12-01', '2010-10-05', NULL, 46),
(85, '2011-01-14', '2009-05-21', '2016-11-27', '2009-08-26', NULL, 27),
(86, '2010-04-05', '2017-12-02', '2020-12-29', '2007-02-16', NULL, 3),
(87, '2001-11-20', '2001-12-31', '2006-07-13', '2014-09-23', NULL, 9),
(88, '2004-08-06', '2013-02-16', '2000-08-25', '2019-07-11', NULL, 77),
(89, '2000-11-14', '2008-02-28', '2014-05-19', '2017-06-21', NULL, 19),
(90, '2013-06-01', '2014-04-15', '2011-06-18', '2007-03-29', NULL, 45),
(91, '2017-06-12', '2004-09-22', '2017-12-26', '2007-05-10', NULL, 66),
(92, '2004-06-07', '2010-08-27', '2020-01-17', '2001-07-30', NULL, 49),
(93, '2020-04-18', '2000-08-03', '2000-04-07', '2009-11-28', NULL, 23),
(94, '2000-08-17', '2002-05-09', '2012-02-29', '2004-11-13', NULL, 10),
(95, '2015-02-15', '2010-10-04', '2020-12-01', '2001-04-08', NULL, 37),
(96, '2017-09-01', '2014-02-02', '2016-07-30', '2006-11-02', NULL, 14),
(97, '2018-11-12', '2017-07-21', '2004-10-30', '2009-12-26', NULL, 37),
(98, '2009-03-23', '2011-11-20', '2018-10-13', '2009-09-15', NULL, 99),
(99, '2000-06-18', '2019-04-26', '2014-01-29', '2001-07-22', NULL, 88),
(100, '2002-06-02', '2000-06-03', '2004-02-26', '2010-07-18', NULL, 47);
-------------------------------------------



/*
+---------------------+
|  quatrième trigger  |
+---------------------+

*/
-------------------------------------------
DELIMITER $$

DROP TRIGGER IF EXISTS compteur_tot_client $$
CREATE TRIGGER compteur_tot_client
AFTER INSERT ON `orders_details`
FOR EACH ROW
BEGIN
    DECLARE nb_commande float;
    DECLARE id_customer int(10);

    SET id_customer = (SELECT ord_cus_id 
                       FROM orders_details
                       INNER JOIN orders
                       ON ode_ord_id = ord_id
                       WHERE ode_id = NEW.ode_id);
    SET nb_commande = 
    (SELECT TRUNCATE(SUM((ode_unit_price * ode_quantity) * (100 - ode_discount)/100 ), 2) 
     FROM orders_details 
     INNER JOIN orders
     ON ode_ord_id = ord_id
     WHERE ord_cus_id = id_customer);

    UPDATE `customers`
    SET cus_tot_orders = (nb_commande) WHERE cus_id = id_customer;

    END $$

DELIMITER ;
-------------------------------------
INSERT INTO `orders_details` (`ode_id`, `ode_unit_price`, `ode_discount`, `ode_quantity`, `ode_ord_id`, `ode_pro_id`) VALUES
(1, '14.99', '0.00', 1, 5, 10),
(2, '14.90', '0.00', 1, 53, 19),
(3, '499.99', '0.00', 1, 53, 22),
(4, '9.90', '0.00', 1, 17, 32),
(5, '88.00', '0.00', 1, 72, 12),
(6, '288.32', '0.00', 1, 20, 28),
(7, '32.50', '5.00', 1, 56, 29),
(8, '88.00', '0.00', 1, 74, 12),
(9, '110.00', '10.00', 1, 47, 7),
(10, '9.98', '0.00', 1, 16, 24),
(11, '157.00', '0.00', 1, 70, 25),
(12, '149.97', '0.00', 1, 37, 30),
(13, '49.00', '0.00', 1, 8, 13),
(14, '88.00', '0.00', 1, 32, 14),
(15, '245.00', '10.00', 1, 7, 31),
(16, '110.00', '10.00', 1, 75, 7),
(17, '245.00', '0.00', 1, 79, 31),
(18, '31.19', '0.00', 1, 29, 18),
(19, '149.97', '0.00', 1, 91, 30),
(20, '31.19', '0.00', 1, 54, 18),
(21, '88.00', '0.00', 1, 68, 12),
(22, '599.99', '0.00', 1, 35, 21),
(23, '49.00', '0.00', 1, 24, 13),
(24, '245.00', '0.00', 1, 78, 31),
(25, '299.40', '0.00', 1, 94, 26),
(26, '110.00', '10.00', 1, 35, 7),
(27, '135.90', '0.00', 1, 77, 11),
(28, '12.00', '0.00', 1, 83, 23),
(29, '157.00', '0.00', 1, 81, 25),
(30, '299.40', '0.00', 1, 48, 26),
(31, '288.32', '0.00', 1, 95, 28),
(32, '110.00', '10.00', 1, 75, 7),
(33, '49.00', '0.00', 1, 31, 13),
(34, '19.90', '0.00', 1, 97, 16),
(35, '49.00', '0.00', 1, 68, 13),
(36, '14.99', '0.00', 1, 47, 10),
(37, '245.00', '0.00', 1, 55, 31),
(38, '249.99', '0.00', 1, 63, 8),
(39, '49.00', '0.00', 1, 14, 13),
(40, '54.49', '0.00', 1, 40, 15),
(41, '49.00', '0.00', 1, 90, 13),
(42, '14.99', '0.00', 1, 63, 10),
(43, '245.00', '0.00', 1, 42, 31),
(44, '31.19', '0.00', 1, 66, 18),
(45, '89.00', '0.00', 1, 26, 27),
(46, '110.00', '10.00', 1, 87, 7),
(47, '9.90', '0.00', 1, 11, 32),
(48, '249.99', '0.00', 10, 9, 8),
(49, '599.99', '0.00', 1, 93, 21),
(50, '19.90', '0.00', 1, 81, 16),
(51, '135.90', '0.00', 1, 47, 11),
(52, '157.00', '10.00', 1, 70, 25),
(53, '110.00', '10.00', 1, 6, 7),
(54, '499.99', '0.00', 1, 61, 22),
(55, '32.50', '0.00', 1, 89, 29),
(56, '135.90', '0.00', 1, 67, 11),
(57, '49.00', '0.00', 1, 11, 13),
(58, '9.90', '0.00', 1, 96, 32),
(59, '157.00', '0.00', 1, 41, 25),
(60, '245.00', '0.00', 1, 60, 31),
(61, '19.90', '0.00', 1, 16, 16),
(62, '499.99', '0.00', 1, 8, 22),
(63, '249.99', '0.00', 1, 19, 8),
(64, '110.00', '10.00', 1, 54, 7),
(65, '299.40', '0.00', 1, 62, 26),
(66, '135.90', '0.00', 1, 56, 11),
(67, '149.97', '0.00', 1, 52, 30),
(68, '245.00', '0.00', 1, 53, 31),
(69, '19.90', '0.00', 1, 52, 16),
(70, '9.98', '50.00', 2, 21, 24),
(71, '9.90', '0.00', 1, 23, 32),
(72, '14.99', '0.00', 1, 37, 10),
(73, '149.97', '0.00', 1, 27, 30),
(74, '32.50', '0.00', 1, 60, 29),
(75, '32.50', '0.00', 1, 40, 29),
(76, '14.90', '0.00', 1, 54, 19),
(77, '88.00', '0.00', 1, 25, 14),
(78, '88.00', '0.00', 1, 85, 12),
(79, '599.99', '0.00', 1, 51, 21),
(80, '599.99', '0.00', 1, 2, 21),
(81, '14.99', '0.00', 1, 97, 10),
(82, '9.90', '0.00', 1, 37, 32),
(83, '9.98', '0.00', 1, 47, 24),
(84, '14.90', '0.00', 1, 70, 19),
(85, '49.00', '60.00', 1, 43, 13),
(86, '31.19', '25.00', 1, 56, 20),
(87, '19.90', '0.00', 1, 72, 16),
(88, '245.00', '0.00', 1, 20, 31),
(89, '31.19', '0.00', 1, 4, 20),
(90, '54.49', '0.00', 1, 86, 15),
(91, '24.90', '0.00', 1, 14, 17),
(92, '249.99', '0.00', 1, 67, 8),
(93, '288.32', '0.00', 1, 6, 28),
(94, '110.00', '10.00', 1, 58, 7),
(95, '110.00', '20.00', 2, 12, 7),
(96, '88.00', '0.00', 1, 100, 12),
(97, '88.00', '0.00', 1, 48, 12),
(98, '245.00', '0.00', 1, 17, 31),
(99, '88.00', '0.00', 1, 39, 12),
(100, '149.97', '0.00', 1, 15, 30);
-------------------------------------